name: Lint and Test

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]
    env:
      PYTHONPATH: ${{ github.workspace }}/src
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff scapy
    - name: Extract PCAP fixtures
      run: |
        python tests/tools/pcap_parser.py tests/fixtures/pcap/rocrail_start.pcapng
        python tests/tools/pcap_parser.py tests/fixtures/pcap/rocrail_fahren.pcapng
        python tests/tools/pcap_parser.py tests/fixtures/pcap/rocrail_schalten.pcapng
        python tests/tools/pcap_parser.py tests/fixtures/pcap/rocrail_edit.pcapng
    - name: Analysing the code with ruff
      run: |
        ruff check $(git ls-files '*.py')
    - name: Run trigger pattern tests
      run: |
        python test_trigger_improved.py
    - name: Run trigger execution tests
      run: |
        python test_trigger_execution.py
    - name: Run trigger callback tests
      run: |
        python test_trigger_callbacks.py
    - name: Run MockCommunicator tests
      run: |
        python test_mock_communicator.py
    - name: Run PCAP state update tests
      run: |
        python test_pcap_state_updates.py
